version: "3.8"
services:
  slide-deck:
    image: node:18-alpine
    working_dir: /app
    command: sh -c "cd /app/server && npm install --production && node index.js"
    volumes:
      - /var/www/slide-deck-app:/app
    env_file:
      - server/.env
    environment:
      - NODE_ENV=production
      - PORT=3788
    networks:
      - minharede1
    deploy:
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.sliderpce.rule=Host(`slides.rpce.com.br`)"
        - "traefik.http.routers.sliderpce.priority=100"
        - "traefik.http.routers.sliderpce.entrypoints=websecure"
        - "traefik.http.routers.sliderpce.tls=true"
        - "traefik.http.routers.sliderpce.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.sliderpce-http.rule=Host(`slides.rpce.com.br`)"
        - "traefik.http.routers.sliderpce-http.priority=100"
        - "traefik.http.routers.sliderpce-http.entrypoints=web"
        - "traefik.http.routers.sliderpce-http.middlewares=redirect-https@docker"
        - "traefik.http.services.sliderpce.loadbalancer.server.port=3788"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3788/api/health"]
      interval: 30s
      timeout: 5s
      retries: 2

networks:
  minharede1:
    external: true
